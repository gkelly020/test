<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arabic Hymn Slide Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background-color: #fdfdfd;
      color: #333;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    p.instructions {
      max-width: 800px;
      margin: 0 auto 1.5rem auto;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    form {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    label {
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
    }
    button {
      padding: 0.7rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #888;
      cursor: not-allowed;
    }
    .message {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #b00;
    }
  </style>
</head>
<body>
  <h1>Arabic Hymn Slide Generator</h1>
  <p class="instructions">
    Plak de Arabische tekst van het lied hieronder. De transliteratie (Franco) en Engelse vertaling worden automatisch voor je opgehaald. Per slide geef je twee regels Arabisch op, die vervolgens worden vertaald en getranslitereerd. Zorg er daarom voor dat het aantal regels een veelvoud van twee is.<br />
    Klik daarna op <strong>Genereer PowerPoint</strong> om een presentatie te downloaden met één slide per twee regels.
  </p>
    <form id="lyricsForm">
    <div>
      <label for="songTitle">Engelse titel van het lied (optioneel):</label>
      <input type="text" id="songTitle" placeholder="Vul hier de titel in Engels in (bijv. We Worship Jesus)" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 1rem;">
    </div>
    <div>
      <label for="arabicText">Arabische tekst (twee regels per slide):</label>
      <textarea id="arabicText" placeholder="Plak hier de Arabische tekst, telkens twee regels per slide. De transliteratie en vertaling worden automatisch gegenereerd."></textarea>
    </div>
    <button type="button" id="generateBtn">Genereer PowerPoint</button>
    <div id="msg" class="message"></div>
  </form>

  <!-- Include the PptxGenJS library from local copy -->
  <script src="pptxgen.bundle.js"></script>
  <script>
    function splitIntoPairs(lines) {
      const pairs = [];
      for (let i = 0; i < lines.length; i += 2) {
        const first = lines[i] || "";
        const second = lines[i + 1] || "";
        pairs.push([first, second]);
      }
      return pairs;
    }

    document.getElementById('generateBtn').addEventListener('click', async () => {
      const msgEl = document.getElementById('msg');
      msgEl.style.color = '#b00';
      msgEl.textContent = '';
      const arabicLines = document.getElementById('arabicText').value.split(/\r?\n/).filter(l => l.trim() !== '');
      if (arabicLines.length % 2 !== 0) {
        msgEl.textContent = 'Het aantal regels moet een even getal zijn (twee regels per slide).';
        return;
      }
      // Vraag het server-API om transliteratie en vertaling
      msgEl.style.color = '#333';
      msgEl.textContent = 'Bezig met vertalen en translitereren…';
      let translationData;
      try {
        const res = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lines: arabicLines })
        });
        if (!res.ok) throw new Error('Vertaalservice gaf een fout terug');
        const json = await res.json();
        translationData = json.results;
      } catch (err) {
        msgEl.textContent = 'Fout bij het ophalen van transliteratie/vertaling: ' + err.message;
        return;
      }
      // Bouw arrays voor transliteratie en vertaling op basis van translationData
      const francoLines = translationData.map(item => item.franco || '');
      const englishLines = translationData.map(item => item.english || '');
      const arabicPairs = splitIntoPairs(arabicLines);
      const francoPairs = splitIntoPairs(francoLines);
      const englishPairs = splitIntoPairs(englishLines);
      const numSlides = Math.max(arabicPairs.length, francoPairs.length, englishPairs.length);
      const pptx = new PptxGenJS();
      pptx.defineLayout({ name: '16x9', width: 10, height: 5.625 });
      pptx.layout = '16x9';
      for (let i = 0; i < numSlides; i++) {
        const slide = pptx.addSlide();
        slide.background = { fill: 'FFFFFF' };
        // Arabic
        const ar1 = (arabicPairs[i] && arabicPairs[i][0]) || '';
        const ar2 = (arabicPairs[i] && arabicPairs[i][1]) || '';
        const arText = [];
        if (ar1) arText.push({ text: ar1 + '\n', options: {} });
        if (ar2) arText.push({ text: ar2, options: {} });
        slide.addText(arText, {
          x: 0.5, y: 0.5, w: 9, h: 1.4,
          color: '000000', fontFace: 'Arial', fontSize: 36,
          // Centreer de Arabische tekst; rtlMode blijft true zodat lettervolgorde correct is
          align: 'center', rtlMode: true
        });
        // Franco
        const fr1 = (francoPairs[i] && francoPairs[i][0]) || '';
        const fr2 = (francoPairs[i] && francoPairs[i][1]) || '';
        const frText = [];
        if (fr1) frText.push({ text: fr1 + '\n', options: {} });
        if (fr2) frText.push({ text: fr2, options: {} });
        slide.addText(frText, {
          x: 0.5, y: 2.2, w: 9, h: 1.2,
          color: 'FF0000', fontFace: 'Arial', fontSize: 32,
          align: 'center'
        });
        // English
        const en1 = (englishPairs[i] && englishPairs[i][0]) || '';
        const en2 = (englishPairs[i] && englishPairs[i][1]) || '';
        const enText = [];
        if (en1) enText.push({ text: en1 + '\n', options: {} });
        if (en2) enText.push({ text: en2, options: {} });
        slide.addText(enText, {
          x: 0.5, y: 3.8, w: 9, h: 1.4,
          color: '0000FF', fontFace: 'Arial', fontSize: 32,
          align: 'center'
        });
      }
      try {
        // Gebruik de opgegeven Engelse titel als bestandsnaam (zonder spaties). Als leeg, gebruik standaardnaam.
        let title = document.getElementById('songTitle').value.trim();
        // Vervang spaties door underscores en verwijder niet‑alfanumerieke tekens
        if (title) {
          title = title.replace(/\s+/g, '_').replace(/[^A-Za-z0-9_\-]/g, '');
        } else {
          title = 'hymn_slides';
        }
        await pptx.writeFile({ fileName: `${title}.pptx` });
        msgEl.style.color = '#28a745';
        msgEl.textContent = 'De presentatie is gegenereerd en wordt gedownload.';
      } catch (err) {
        msgEl.style.color = '#b00';
        msgEl.textContent = 'Er is een fout opgetreden bij het genereren van de presentatie.';
        console.error(err);
      }
    });
  </script>
</body>
</html>